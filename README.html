<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<p><a href="http://travis-ci.org/Oslandia/lopocs"><img src="https://img.shields.io/travis/Oslandia/lopocs/master.svg?style=flat-square&amp;label=unix%20build" alt="Build status of the master branch" /></a></p>
<p><a href="https://raw.githubusercontent.com/LI3DS/pg_li3ds/master/LICENSE.txt"><img src="https://img.shields.io/badge/license-LGPL-blue.svg?style=flat-square" alt="Package license" /></a></p>
<p><img src="docs/lopocs.png" alt="image" width="400" /></p>
<p>LOPoCS (Light Opensource PointCloud Server) is a point cloud server written in Python, allowing to load Point Cloud from Postgis thanks to the pgpointcloud extension.</p>
<p><img src="docs/itowns_montreal1_header.png" alt="image" width="700" /></p>
<p>The current version of LOPoCS provides a way to load Point Cloud from Postgis in:</p>
<ul>
<li>[Potree viewer](<a href="http://www.potree.org/" class="uri">http://www.potree.org/</a> “Potree viewer”) viewer with LAZ compressed data</li>
<li>[iTowns2](<a href="https://github.com/iTowns/itowns2" class="uri">https://github.com/iTowns/itowns2</a> “iTowns2”) on the side of other data type</li>
<li>[Cesium](<a href="https://github.com/AnalyticalGraphicsInc/cesium" class="uri">https://github.com/AnalyticalGraphicsInc/cesium</a> “Cesium”) thanks to the [3DTiles](<a href="https://github.com/AnalyticalGraphicsInc/3d-tiles" class="uri">https://github.com/AnalyticalGraphicsInc/3d-tiles</a> “3DTiles”) format</li>
</ul>
<p>Note that LOPoCS is currently the only 3DTiles server able to stream data from [pgpointcloud](<a href="https://github.com/pgpointcloud/pointcloud" class="uri">https://github.com/pgpointcloud/pointcloud</a> “pgpointcloud”). This is possible thanks to the python module [py3dtiles](<a href="https://github.com/Oslandia/py3dtiles" class="uri">https://github.com/Oslandia/py3dtiles</a> “py3dtiles”).</p>
<p>Developments are still going on to improve state-of-the-art algorithms and performances.</p>
<p>[Video](<a href="https://vimeo.com/189285883" class="uri">https://vimeo.com/189285883</a> “Video”)</p>
<p>[Online demonstration](<a href="https://li3ds.github.io/lopocs/" class="uri">https://li3ds.github.io/lopocs/</a> “Online demonstration”)</p>
<p>## Install</p>
<p>### From sources</p>
<p>To use LOPoCS from sources:</p>
<p><code>` $ sudo apt-get install libgdal-dev $ git clone https://github.com/Oslandia/lopocs $ cd lopocs $ virtualenv -p /usr/bin/python3 venv $ . venv/bin/activate (venv)$ pip install --upgrade pip (venv)$ pip install -e .</code>`</p>
<p>If you want to run unit tests:</p>
<p><code>` (venv)$ pip install nose (venv)$ nosetests ...</code>`</p>
<p>## Prepare your database to welcome point clouds data</p>
<blockquote>
<p>$ createdb pc_airport $ psql pc_airport pc_airport=# create extension postgis; CREATE EXTENSION pc_airport=# create extension pointcloud; CREATE EXTENSION pc_airport=# create extension pointcloud_postgis; CREATE EXTENSION pc_airport=# create extension morton; CREATE EXTENSION `</p>
</blockquote>
<p>## Fill the database with lopocs command line</p>
<p><strong>lopocs_builder</strong> is a powerful tool allowing to - load and configure the database with extensions - fill the database with points thanks to PDAL - generate configuration file for uWSGI - generate web page for several viewers (like Potree)</p>
<p>In other words, only one command line is standing between you and streaming point clouds from Postgis!</p>
<p>### Dependancies</p>
<p>#### Vagrant VM</p>
<p>The easy way is to use the Vagrant VM which is fully configured! But you have to build it first:</p>
<p><code>` $ cd vagrant $ vagrant up</code>`</p>
<p>Then you can connect to the VM with ssh:</p>
<p><code>` $ vagrant ssh &gt; TODO</code>`</p>
<p>#### From sources</p>
<p>In order to have an efficient and a reactive streaming, we’ve made some development in PDAL and pgpointcloud.</p>
<p>Some of these developments are not merged in upstream projects yet (but of course, it’s the intention). So you have to use some forks from the LI3DS project to be able to use <strong>lopocs_builder</strong>:</p>
<ul>
<li>[LI3DS/pgpointcloud width dev branch](<a href="https://github.com/LI3DS/pointcloud/tree/dev" class="uri">https://github.com/LI3DS/pointcloud/tree/dev</a>)</li>
<li>[LI3DS/PDAL with e57reader branch](<a href="https://github.com/LI3DS/PDAL/tree/e57reader" class="uri">https://github.com/LI3DS/PDAL/tree/e57reader</a>)</li>
</ul>
<p>Moreover, the [Morton Postgres extension](<a href="https://github.com/Oslandia/pgmorton" class="uri">https://github.com/Oslandia/pgmorton</a>) is necessary.</p>
<p>Here are a few tips to compile everything:</p>
<p><code>` TODO</code>`</p>
<p>### Usage</p>
<p><code>` $ lopocs_builder --help usage: lopocs_builder [-h] [-epsg epsg] [--confonly] [--potreeviewer]                       [--force] [-pg_user pg_user] [-pg_table pg_table]                       [-pg_host pg_host] [-pg_port pg_port] [-pg_pwd pg_pwd]                       [-pdal_patchsize size] [-pdal_reader reader]                       [-morton_size size] [-lod_max lod_max]                       [-lopocs_cachedir dir] [-uwsgi_host uwsgi_host]                       [-uwsgi_port uwsgi_port] [-uwsgi_log uwsgi_log]                       [-uwsgi_venv uwsgi_venv]                       files outdir pg_db  Prepare database for LOPoCS  positional arguments:   files                 input files. A regex can be used: 'input/*.las'   outdir                output directory   pg_db                 postgres database  optional arguments:   -h, --help            show this help message and exit   -epsg epsg            EPSG code (default: 4326)   --confonly            print current configuration only   --potreeviewer        configure Potree viewer   --force               remove database and output directory if they exist   -pg_user pg_user      postgres user (default: USER)   -pg_table pg_table    postgres table (default: patchs)   -pg_host pg_host      postgres host (default: localhost)   -pg_port pg_port      postgres port (default: 5432)   -pg_pwd pg_pwd        postgres password (default: )   -pdal_patchsize size  number of points per patch (default: 500)   -pdal_reader reader   PDAL reader to use in the pipeline (default: las)   -morton_size size     Grid size to compute the Morton Code (default: 64)   -lod_max lod_max      Maximum Level Of Detail (default: 6)   -lopocs_cachedir dir  LOPoCS cache directory (default:                         '/home/USER/.cache/lopocs/')   -uwsgi_host uwsgi_host                         uWSGI host through which LOPoCS will be available                         (default: 127.0.0.1)   -uwsgi_port uwsgi_port                         uWSGI port through which LOPoCS will be available                         (default: 5000)   -uwsgi_log uwsgi_log  uWSGI logfile (default: /tmp/lopocs.log)   -uwsgi_venv uwsgi_venv                         uWSGI virtualenv (default: /home/USER/devel/packa                         ges/li3ds/lopocs/tools/../venv)</code>`</p>
<p>## API and Swagger</p>
<p>Each viewer has specific expectations and communication protocol. So, the API is built to meet these specific needs.</p>
<p>Currently, 2 kinds of formats are supported: - 3DTiles - Greyhound format (LAZ data with a footer indicating the number of points)</p>
<p>LOPoCS is able to stream data up to 3 viewers: - Potree viewer with the Greyhound format - iTowns2 with the Greyhound format - Cesium with the 3DTiles format</p>
<p>LOPoCS provides its RESTful API through a Swagger UI by default on *<a href="http://localhost:5000*" class="uri">http://localhost:5000*</a>:</p>
<p>&lt;p align=“center”&gt; &lt;img align=“center” src=“<a href="https://github.com/LI3DS/lopocs/blob/master/docs/api.png" class="uri">https://github.com/LI3DS/lopocs/blob/master/docs/api.png</a>” width=“700”&gt; &lt;/p&gt;</p>
<p>There’s three namespace: - <strong>infos</strong>: to retrieve informations about LOPoCS (contact, …) - <strong>greyhound</strong>: to communicate with LOPoCS according to the Greyhound format - <strong>3dtiles</strong>: to communicate with LOPoCS according to the 3DTiles format</p>
<p>### Infos Namespace</p>
<p>&lt;p align=“center”&gt; &lt;img align=“center” src=“<a href="https://github.com/LI3DS/lopocs/blob/master/docs/api_infos.png" class="uri">https://github.com/LI3DS/lopocs/blob/master/docs/api_infos.png</a>” width=“700”&gt; &lt;/p&gt;</p>
<p>You can retrieve simple information about LOPoCS through this namespace. There are no settings in this case, just simple query:</p>
<p><code>` $ curl http://localhost:5000/infos/contact &quot;infos+li3ds@oslandia.com&quot;</code>`</p>
<p>### Greyhound Namespace</p>
<p>&lt;p align=“center”&gt; &lt;img align=“center” src=“<a href="https://github.com/LI3DS/lopocs/blob/master/docs/api_greyhound.png" class="uri">https://github.com/LI3DS/lopocs/blob/master/docs/api_greyhound.png</a>” width=“700”&gt; &lt;/p&gt;</p>
<p>The <strong>greyhound</strong> namespace provides 3 points of entry: - info: returns information about the dataset served by the server in JSON - hierarchy: returns the description of the dataset according to an octree in JSON - read: returns points in LAZ format</p>
<p>### 3DTiles Namespace</p>
<p>&lt;p align=“center”&gt; &lt;img align=“center” src=“<a href="https://github.com/LI3DS/lopocs/blob/master/docs/api_3dtiles.png" class="uri">https://github.com/LI3DS/lopocs/blob/master/docs/api_3dtiles.png</a>” width=“700”&gt; &lt;/p&gt;</p>
<p>The <strong>3dtiles</strong> namespace provides 2 points of entry: - info: returns information about the dataset in JSON - read.pnts: returns points in 3DTiles Point Cloud format</p>
<p>## Full examples</p>
<p>Some examples with <strong>las</strong> and <strong>e57</strong> files are available in <em>examples</em> directory.</p>
<p>### Saint Sulpice</p>
<p>An example with St Sulpice point cloud (e57 format) coming from [here](<a href="http://www.libe57.org/data.html" class="uri">http://www.libe57.org/data.html</a>):</p>
<p><code>` (venv)$ cd examples/stsulpice (venv)$ sh potree.sh ....</code>`</p>
<p>By running this command, the e57 file is downloaded and <strong>lopocs_builder</strong> is called in this way:</p>
<p><code>` lopocs_builder Trimble_StSulpice-Cloud-50mm.e57 outdir pc_stsulpice \                -lod_max 4 -lopocs_cachedir outdir/cache -pdal_reader e57 \                --force --potreeviewer</code>`</p>
<p>After a few minutes, <strong>lopocs_builder</strong> is done:</p>
<p><code>` (venv)$ sh potree.sh ============================================================ LOPoCS configuration ============================================================  General  - files: Trimble_StSulpice-Cloud-50mm.e57  - output directory: lopocs/examples/stsulpice/outdir  - epsg code: EPSG:4326  - force: True  Postgres  - host: localhost  - database: pc_stsulpice  - port: 5432  - table: patchs  - user: USER  - password:  PDAL  - reader: e57  - patch size: 500  Morton  - grid size: 64  Hierarchy  - lod max: 4  LOPoCS  - cache directory: lopocs/examples/stsulpice/outdir/cache  uWSGI  - host: 127.0.0.1  - port: 5000  - logfile: /tmp/lopocs.log  - virtualenv: lopocs/tools/../venv  Viewer(s)  - PotreeViewer: True  ============================================================ LOPoCS check environment ============================================================  dropdb...: /usr/local/bin/dropdb createdb...: /usr/local/bin/createdb pdal...: /usr/local/bin/pdal pdal-config...: /usr/local/bin/pdal-config pdal plugin midoc filter...: /usr/local/lib/libpdal_plugin_filter_midoc.so pdal plugin pgpointcloud writer...: /usr/local/lib/libpdal_plugin_writer_pgpointcloud.so  ============================================================ LOPoCS prepare ============================================================  Search input file(s)...: OK Remove output directory...: OK Drop database...: OK Initialize output directory...: OK Initialize cache directory...: OK  ============================================================ LOPoCS initialize database ============================================================  Create the database...: OK Initialize connection with database...: OK Load postgis extension...: OK Load pointcloud extension...: OK Load pointcloud_postgis extension...: OK Load morton extension...: OK  ============================================================ LOPoCS fill database ============================================================  Build PDAL pipelines...: OK Run PDAL pipelines...: OK  ============================================================ LOPoCS preprocessing ============================================================  Extract bounding box...: OK  Insert Potree schema for scale=0.1...: OK Insert Potree schema for scale=0.01...: OK  Compute Morton code...: OK  Generate a hierarchy file for Potree...: OK Paste the Potree hierarchy in LOPoCS cache directory...: OK  Generate a configuration file for LOPoCS...: OK Generate a configuration file for uWSGI...: OK  ============================================================ LOPoCS configure viewer(s) ============================================================  Copy Potree project...: OK Prepare Potree html file...: OK  Duration: 8484500 points processed in 374.0738787651062 seconds with LOD 4.</code>`</p>
<p>Then you can run LOPoCS with uWSGI and the configuration file generated by <strong>lopocs_builder</strong>:</p>
<p><code>` (venv)$ pip install uwsgi (venv)$ uwsgi -y outdir/lopocs.uwsgi.yml ...</code>`</p>
<p>To test if LOPoCS is well online:</p>
<p><code>` $ curl http://localhost:5000/infos/online &quot;Congratulation, LOPoCS is online!!!&quot;</code>`</p>
<p>Then you can use Potree viewer to stream points from the database with your favorite web browser tanks to the <em>potree.html</em> file generated by <strong>lopocs_builder</strong>:</p>
<p><code>` $ chromium outdir/potree.html</code>`</p>
<p>&lt;br&gt; &lt;p align=“center”&gt; &lt;img align=“center” src=“<a href="https://github.com/LI3DS/lopocs/blob/dev/docs/stsulpice.png" class="uri">https://github.com/LI3DS/lopocs/blob/dev/docs/stsulpice.png</a>” width=“700”&gt; &lt;/p&gt; &lt;br&gt;</p>
<p>## Advanced usage</p>
<p>If you want to manually fill the database without <strong>lopocs_builder</strong> (or if it doesn’t work), you’ll need some further explications.</p>
<p>### Download a LAS file</p>
<p><code>` $ wget www.liblas.org/samples/LAS12_Sample_withRGB_Quick_Terrain_Modeler_fixed.las $ mv LAS12_Sample_withRGB_Quick_Terrain_Modeler_fixed.las airport.las</code>`</p>
<p>### Initialize the database</p>
<p>The first step is to create the database and load extensions:</p>
<p><code>` $ createdb pc_airport $ psql pc_airport psql (9.5.1) Type &quot;help&quot; for help.  pc_airport=# create extension postgis; CREATE EXTENSION pc_airport=# create extension pointcloud; CREATE EXTENSION pc_airport=# create extension pointcloud_postgis; CREATE EXTENSION pc_airport=# create extension morton; CREATE EXTENSION</code>`</p>
<p>### Using PDAL to fill the database</p>
<p>Firstly, you have to write a PDAL pipeline according to your format file, the spatial reference, and so on… But the chipper and midoc filter as well as the pgpointcloud writer are mandatory.</p>
<p>The pipeline for the <em>airport.las</em> file is named <em>pipe.json</em> and looks like:</p>
<p><code>` {   &quot;pipeline&quot;:[     {       &quot;type&quot;:&quot;readers.las&quot;,       &quot;filename&quot;:&quot;airport.las&quot;,       &quot;spatialreference&quot;:&quot;EPSG:32616&quot;     }     ,     {       &quot;type&quot;:&quot;filters.chipper&quot;,       &quot;capacity&quot;:500     },     {       &quot;type&quot;:&quot;filters.midoc&quot;     },     {       &quot;type&quot;:&quot;writers.pgpointcloud&quot;,       &quot;connection&quot;:&quot;dbname=pc_airport&quot;,       &quot;table&quot;:&quot;patchs&quot;,       &quot;compression&quot;:&quot;lazperf&quot;,       &quot;srid&quot;:&quot;32616&quot;,       &quot;overwrite&quot;:&quot;false&quot;     }   ] }</code>`</p>
<p>Then you can run PDAL:</p>
<p><code>` $ pdal pipeline -i pipe.json</code>`</p>
<p>### Morton indexing</p>
<p>Once you have patchs of points in database thanks to PDAL, you have to compute a Morton code for each one of them:</p>
<p><code>` $ psql pc_airport psql (9.5.1) Type &quot;help&quot; for help.  pc_airport=# ALTER TABLE patchs add column morton bigint; ALTER TABLE pc_airport=# SELECT Morton_Update('patchs', 'pa::geometry', 'morton', 64, TRUE) SELECT pc_airport=# CREATE INDEX ON patchs(morton); CREATE INDEX</code>`</p>
<p>### Configuration file for uWSGI and LOPoCS</p>
<p>For LOPoCS running with uWSGI only (without web server such as Nginx), the configuration file looks like:</p>
<p><code>` # uWSGI configuration: lopocs.uwsgi.yml uwsgi:     virtualenv: lopocs/venv     master: true     socket: 127.0.0.1:5000     protocol: http     module: lopocs.wsgi:app     processes: 4     enable-threads: true     lazy-apps: true     need-app: true     catch: exceptions=true     env: LOPOCS_SETTINGS=lopocs.yml</code>`</p>
<p><code>` # LOPoCS configuration: lopocs.yml flask:     DEBUG: True     LOG_LEVEL: debug     PG_HOST: localhost     PG_USER: USER     PG_NAME: pc_airport     PG_PORT: 5432     PG_COLUMN: pa     PG_TABLE: patchs     PG_PASSWORD:     DEPTH: 6     USE_MORTON: True     CACHE_DIR: ~/.cache/lopocs     STATS: False</code>`</p>
<p>So, if you want to run LOPoCS:</p>
<p><code>` $ uwsgi -y lopocs.uwsgi.yml</code>`</p>
<p>### [For Potree] Schemas in pgpointcloud</p>
<p>Potree waits from the streaming server a specific point structure:</p>
<p><code>` X: int32 scaled and offsetted Y: int32 scaled and offsetted Z: int32 scaled and offsetted Intensity: uint16 Classification: uint8 Red: uint16 Green: uint16 Blue: uint16</code>`</p>
<p>The offset is the center of the bounding box of your data. Note that it should be the same box sent by the <em>/info</em> response coming from LOPoCS. To retrieve the boundaries:</p>
<p><code>` $ pdal info --summary airport.las ...     &quot;bounds&quot;:     {       &quot;X&quot;:       {         &quot;max&quot;: 728998.1352,         &quot;min&quot;: 728262.8032       },       &quot;Y&quot;:       {         &quot;max&quot;: 4677014.685,         &quot;min&quot;: 4676439.353       },       &quot;Z&quot;:       {         &quot;max&quot;: 327.0779649,         &quot;min&quot;: 292.6479649       } } ...</code>`</p>
<p>Thus:</p>
<p><code>` OFFSET_X = 728262.803 + (728998.135 - 728262.803) / 2 = 728630.469 OFFSET_Y = 4676439.353 + (4677014.685 - 4676439.353) / 2 = 4676727.019 OFFSET_Z = 292.6479649 + (327.0779649 - 292.6479649) / 2 = 309.8629649</code>`</p>
<p>Then we have to build pointcloud schemas with these offsets and two different scales (0.1 and 0.01):</p>
<p><code>` $ cp docs/potree_schema_scale_01.sql airport_schema_scale_01.sql $ sed -i -e &quot;s@!XOFFSET!@728630.469@g&quot; airport_schema_scale_01.sql $ sed -i -e &quot;s@!YOFFSET!@4676727.019@g&quot; airport_schema_scale_01.sql $ sed -i -e &quot;s@!ZOFFSET!@309.8629649@g&quot; airport_schema_scale_01.sql $ sed -i -e &quot;s@!SRID!@32616@g&quot; airport_schema_scale_01.sql $ cp docs/potree_schema_scale_001.sql airport_schema_scale_001.sql $ sed -i -e &quot;s@!XOFFSET!@728630.469@g&quot; airport_schema_scale_001.sql $ sed -i -e &quot;s@!YOFFSET!@4676727.019@g&quot; airport_schema_scale_001.sql $ sed -i -e &quot;s@!ZOFFSET!@309.8629649@g&quot; airport_schema_scale_001.sql $ sed -i -e &quot;s@!SRID!@32616@g&quot; airport_schema_scale_001.sql</code>`</p>
<p>These schemas have to be inserted in the database:</p>
<p><code>` $ psql pc_airport -f airport_schema_scale_01.sql $ psql pc_airport -f airport_schema_scale_001.sql</code>`</p>
<p>### [For Potree] Hierarchy computation</p>
<p>A hierarchy, described in Json, is necessary for the Potree loader.</p>
<p>If you want a full description of what a Greyhound hierarchy is, you can take a look [here](<a href="https://github.com/hobu/greyhound/blob/master/doc/clientDevelopment.rst" class="uri">https://github.com/hobu/greyhound/blob/master/doc/clientDevelopment.rst</a>).</p>
<p>A simple Python script is provided by LOPoCS to build a hierarchy from a pgpointcloud database:</p>
<p><code>` $ python3 tools/build_hierarchy.py lopocs.yml . greyhound</code>`</p>
<p>Once the hierarchy file <em>potree.hcy</em> is created, you can paste it in the cache directory and update the LOPoCS configuration file accordingly:</p>
<p><code>` # LOPoCS configuration: lopocs.yml flask:     DEBUG: True     ...     ROOT_HCY: potree.hcy     ...</code>`</p>
</body>
</html>
